<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>Lab B1. DEX 1: Swap settlement - BADD Labs</title>
        <link href="../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../css/font-awesome.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css">

        <script src="../../js/jquery-1.10.2.min.js" defer></script>
        <script src="../../js/bootstrap.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../..">BADD Labs</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="navitem">
                                <a href="../.." class="nav-link">Home</a>
                            </li>
                            <li class="dropdown active">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Labs <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../A1/" class="dropdown-item">Lab A1. Transaction exploration</a>
</li>
                                    
<li>
    <a href="../A2/" class="dropdown-item">Lab A2. Smart-contract programming</a>
</li>
                                    
<li>
    <a href="../A3/" class="dropdown-item">Lab A3. Blockchain mining</a>
</li>
                                    
<li>
    <a href="./" class="dropdown-item active">Lab B1. DEX 1: Swap settlement</a>
</li>
                                    
<li>
    <a href="../B2/" class="dropdown-item">Lab B2. DEX 2: AMM and pricing</a>
</li>
                                    
<li>
    <a href="../B3/" class="dropdown-item">Lab B3. DEX security: Arbitrage</a>
</li>
                                    
<li>
    <a href="../B4/README.md" class="dropdown-item">Lab B4. DEX security: Sandwich</a>
</li>
                                </ul>
                            </li>
                            <li class="navitem">
                                <a href="../../about/" class="nav-link">About</a>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../A3/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../B2/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="1"><a href="#lab-b1-amm-dex" class="nav-link">Lab B1: AMM DEX</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#introduction" class="nav-link">Introduction</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#exercise-1-execute-erc20-token-transfer" class="nav-link">Exercise 1. Execute ERC20 token transfer</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#exercise-2-extend-baddtoken-with-approvetransferfrom" class="nav-link">Exercise 2. Extend BaddToken with approve/transferFrom</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#exercise-3-amm-design-with-fixed-rate" class="nav-link">Exercise 3. AMM Design with Fixed Rate</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#exercise-3-constant-product-amm" class="nav-link">Exercise 3. Constant-product AMM</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#exercise-4-supporting-token-approvetransferfrom" class="nav-link">Exercise 4. Supporting Token Approve/transferFrom</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#exercise-5-security-against-pool-theft" class="nav-link">Exercise 5. Security against Pool Theft</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#exercise-6-security-against-trader-theft" class="nav-link">Exercise 6. Security against Trader Theft</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#deliverable" class="nav-link">Deliverable</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="lab-b1-amm-dex">Lab B1: AMM DEX</h1>
<h2 id="introduction">Introduction</h2>
<p>An automated market maker (AMM) is a decentralized-exchange (DEX) protocol. In an AMM, a trader trades with a smart-contract intermediary called pool (which is unlike other DEX designs like order book).
In practice, AMM is the most widely adopted DEX design and is the protocol followed by popular services including Uniswap, Sushiswap, Pancakeswap, etc.</p>
<p>In this lab, you will being implement an AMM.</p>
<table>
<thead>
<tr>
<th>Tasks</th>
<th>Points</th>
<th>CS student</th>
<th>Finance student</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>20</td>
<td>Required</td>
<td>Bonus</td>
</tr>
<tr>
<td>2</td>
<td>30</td>
<td>Required</td>
<td>Bonus</td>
</tr>
<tr>
<td>3</td>
<td>50</td>
<td>Required</td>
<td>Bonus</td>
</tr>
</tbody>
</table>
<h2 id="exercise-1-execute-erc20-token-transfer">Exercise 1. Execute ERC20 token transfer</h2>
<p>The following smart contract implements a very simple token supporting the essential transfer function: <code>transfer(address sender, address recipient, uint256 amount)</code> </p>
<pre><code>pragma solidity &gt;=0.7.0 &lt;0.9.0; 
contract BaddToken {  
  uint _totalSupply = 0; string _symbol;  
  mapping(address =&gt; uint) balances;  
  constructor(string memory symbol, uint256 initialSupply) {
    _symbol = symbol;
    _totalSupply = initialSupply;
    balances[msg.sender] = _totalSupply;  
  }

  function transfer(address receiver, uint amount) public returns (bool) {    
    require(amount &lt;= balances[msg.sender]);        
    balances[msg.sender] = balances[msg.sender] - amount;    
    balances[receiver] = balances[receiver] + amount;    
    return true;  
  }

  function balanceOf(address account) public view returns(uint256){
    return balances[account];
  }}
</code></pre>
<p>Your job in this exercise is to deploy the above smart contract in Remix, creating an <code>TokenX</code> instance. Demonstrate the process that the <code>TokenX</code> issuer transfers 10 <code>TokenX</code> to another account, say Alice, and display each account's balance before/after the transfer.</p>
<h2 id="exercise-2-extend-baddtoken-with-approvetransferfrom">Exercise 2. Extend <code>BaddToken</code> with approve/transferFrom</h2>
<pre><code>function approve(address spender, uint256 amount) external returns (bool);
function transferFrom(address from, address to, uint256 amount) external returns (bool);
function allowance(address owner, address spender) external view returns (uint256);
</code></pre>
<p>Your job is to extend the <code>BaddToken</code> with the approve and transferFrom functions defined as above. Suppose owner Alice wants to transfer 1 <code>BaddToken</code> to another account Bob through an intermediary Charlie. Alice first calls <code>approve(Charlie, 1)</code> which gives Charlie allowance of 1 <code>BaddToken</code>. Then, Charlie calls function <code>transferFrom(Alice, Bob, 1)</code>, through which Charlie's balance is credited by 1 <code>BaddToken</code> and Alice's balance is debited by 1 <code>BaddToken</code>.</p>
<p>We use the following table to test/grade if your solution is correct. For instance, we may send a sequence of transaction against the instances of your <code>BaddToken</code>: <code>Alice.approve(Charlie, 1)</code>, <code>balanceOf(Alice)</code>, <code>allowance(Alice, Charlie)</code>, <code>balanceOf(Bob)</code>, <code>Charlie.transferFrom(Alice, Bob, 1)</code>, <code>balanceOf(Bob)</code>. And we expect a correct result being <code>1,1,0,1</code>.</p>
<table>
<thead>
<tr>
<th>Calls</th>
<th><code>balanceOf(Alice)</code></th>
<th><code>balanceOf(Bob)</code></th>
<th><code>allowance(Alice, Charlie)</code></th>
</tr>
</thead>
<tbody>
<tr>
<td>Init state</td>
<td>1</td>
<td>0</td>
<td>0</td>
</tr>
<tr>
<td><code>Alice.approve(Charlie, 1)</code></td>
<td>1</td>
<td>0</td>
<td>1</td>
</tr>
<tr>
<td><code>Charlie.transferFrom(Alice, Bob, 1)</code></td>
<td>0</td>
<td>0</td>
<td>1</td>
</tr>
</tbody>
</table>
<h2 id="exercise-3-amm-design-with-fixed-rate">Exercise 3. AMM Design with Fixed Rate</h2>
<p><img alt="AMM design diagram" src="lab-amm.png" /></p>
<p>In the figure above, trader Alice first transfers $x$ units of <code>TokenX</code> from her account to an AMM pool's account. Then, she calls the AMM smart contract's function <code>swapXY(dx)</code>. Upon receiving Alice's transaction, the AMM smart contract internally calls <code>TokenY</code>'s <code>transfer</code> function to transfer $dy$ units of <code>TokenY</code> to Alice's account.</p>
<p>In this exercise, you can consider that $dy/dx = 2$. Implement the AMM smart contract.</p>
<pre><code>pragma solidity &gt;=0.7.0 &lt;0.9.0; 
contract AMM {
  BaddToken tokenX, tokenY;
  // _tokenX and _tokenY are contract-addresses running BaddToken SC
  constructor(address _tokenX, address _tokenY){
    tokenX = BaddToken(_tokenX); tokenY = BaddToken(_tokenY);
  }

  function swapXY(uint amountX) public payable {
    // fill out the following with your code
  } 
}
</code></pre>
<ul>
<li>Workflow to execute your code:<ul>
<li>Write and compile an <code>AMM</code> smart contract.</li>
<li>Deploy <code>BaddToken</code> smart contract twice, respectively to two contract addresses, say <code>_tokenX</code> and <code>_tokenY</code>.</li>
<li>Deploy <code>AMM</code> smart contract with <code>_tokenX</code> and <code>_tokenY</code>.</li>
<li>Execute the smart contracts in two steps: <ul>
<li>1) call <code>_tokenX</code>'s <code>transfer</code> function</li>
<li>2) call <code>AMM</code>'s <code>swapXY</code> function</li>
</ul>
</li>
</ul>
</li>
<li>Hint: You need to make sure your account has enough tokens for both <code>_tokenX</code> and <code>_tokenY</code>.</li>
</ul>
<h2 id="exercise-3-constant-product-amm">Exercise 3. Constant-product AMM</h2>
<p>Suppose the AMM account owns $x$ units of <code>TokenX</code> and $y$ units of <code>TokenY</code>. The AMM pool can use a function $f(x,y)$ to calculate the exchange rate between <code>TokenX</code> and <code>TokenY</code> on the fly. Specifically, it enforces that function value is constant before and after each token swap, that is,</p>
<p>$$f(x,y)=f(x+dx,y-dy)$$</p>
<p>In this exercise, you are asked to implement constant-product AMM (adopted in the real-life Uniswap), where $f(x,y)=x*y$. Modify your AMM smart contract to support the constant-product invariant $x*y=(x+dx)(y-dy)$.</p>
<ul>
<li>Hint: You may want to keep track of token balance $x$ and $y$ in the AMM smart contact by issuing <code>balanceOf</code> in each <code>swapXY</code> call.</li>
</ul>
<table>
<thead>
<tr>
<th>Case</th>
<th>tx1</th>
<th>tx2</th>
<th>Solution</th>
</tr>
</thead>
<tbody>
<tr>
<td>Normal case</td>
<td>Alice</td>
<td>Alice</td>
<td>Exercise 1-3</td>
</tr>
<tr>
<td>Dangling swap</td>
<td>Alice</td>
<td>NULL</td>
<td>Exercise 4 (<code>approve</code>/<code>transferFrom</code>)</td>
</tr>
<tr>
<td>Theft from pool</td>
<td>NULL</td>
<td>Alice</td>
<td>Exercise 5 (Track deposits)</td>
</tr>
<tr>
<td>Theft from Bob</td>
<td>Bob</td>
<td>Alice</td>
<td>Exercise 6</td>
</tr>
</tbody>
</table>
<h2 id="exercise-4-supporting-token-approvetransferfrom">Exercise 4. Supporting Token Approve/transferFrom</h2>
<p><img alt="AMM design diagram" src="lab-amm-tff.png" /></p>
<h2 id="exercise-5-security-against-pool-theft">Exercise 5. Security against Pool Theft</h2>
<h2 id="exercise-6-security-against-trader-theft">Exercise 6. Security against Trader Theft</h2>
<h2 id="deliverable">Deliverable</h2>
<ul>
<li>For all tasks, you should 1) submit your smart-contract code, and 2) show the screenshot of the program execution. </li>
</ul></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js" defer></script>
        <script src="../../javascripts/mathjax.js" defer></script>
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6" defer></script>
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" defer></script>
        <script src="../../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
