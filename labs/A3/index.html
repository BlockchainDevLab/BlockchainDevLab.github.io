<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>Lab A3. Blockchain mining - BADD Labs</title>
        <link href="../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../css/font-awesome.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css">

        <script src="../../js/jquery-1.10.2.min.js" defer></script>
        <script src="../../js/bootstrap.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../..">BADD Labs</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="navitem">
                                <a href="../.." class="nav-link">Home</a>
                            </li>
                            <li class="dropdown active">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Labs <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../A1/" class="dropdown-item">Lab A1. Transaction exploration</a>
</li>
                                    
<li>
    <a href="../A2/" class="dropdown-item">Lab A2. Smart-contract programming</a>
</li>
                                    
<li>
    <a href="./" class="dropdown-item active">Lab A3. Blockchain mining</a>
</li>
                                    
<li>
    <a href="../B1/" class="dropdown-item">Lab B1. DEX 1: Swap settlement</a>
</li>
                                    
<li>
    <a href="../B2/" class="dropdown-item">Lab B2. DEX 2: AMM and pricing</a>
</li>
                                    
<li>
    <a href="../B3/" class="dropdown-item">Lab B3. DEX security: Arbitrage</a>
</li>
                                    
<li>
    <a href="../B4/README.md" class="dropdown-item">Lab B4. DEX security: Sandwich</a>
</li>
                                </ul>
                            </li>
                            <li class="navitem">
                                <a href="../../about/" class="nav-link">About</a>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../A2/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../B1/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="1"><a href="#lab-a3-mining-in-an-on-campus-ethereum-network" class="nav-link">Lab A3: Mining in an On-Campus Ethereum Network</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#prerequisite" class="nav-link">Prerequisite</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#lab-environment-setup" class="nav-link">Lab Environment Setup</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#lab-tasks" class="nav-link">Lab Tasks</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#deliverable" class="nav-link">Deliverable</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#faqtrouble-shooting" class="nav-link">FAQ/Trouble shooting</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="lab-a3-mining-in-an-on-campus-ethereum-network">Lab A3: Mining in an On-Campus Ethereum Network</h1>
<p>In this lab, you are given the initial state that a custom Blockchain network of several miners is hosted on an on-campus machine which has been running for several days before the class. The Blockchain machine also runs a daemon that periodically instructs some miner to conduct transactions with other miners.</p>
<h2 id="prerequisite">Prerequisite</h2>
<ol>
<li>Have experience in Linux shell commands</li>
<li>Understand <a href="http://www.ethdocs.org/en/latest/introduction/index.html">Ethereum</a></li>
</ol>
<h2 id="lab-environment-setup">Lab Environment Setup</h2>
<h3 id="1a-download-our-vm-with-ethereum">1A. Download our VM with Ethereum</h3>
<p>Install VirtualBox on your computer: https://www.virtualbox.org/wiki/Downloads . Choose <code>Ubuntu-64</code> bit option while installing the VM.</p>
<p>Download our prebuilt VirtualBox image from [<a href="https://drive.google.com/file/d/1VVL02K90UUY66hN41UdGc_2SteS1yjpY/view?usp=sharing">here</a>]. Import the image as <code>Appliance</code> inside VirtualBox. The credential for the VM is: username:<code>user1</code>, password:<code>blockchainsu</code>. </p>
<p><strong><em>Script 1a</em></strong>: </p>
<pre><code>mkdir -p ~/lab1/bkc_data
cd ~/lab1
gedit genesis.json
</code></pre>
<p>Copy this online file [<a href="https://raw.githubusercontent.com/syracuse-fullstacksecurity/SUBlockchainLabs/master/lab1/genesis.json">link</a>] to the gedit and save it (by hitting <code>control+S</code> in Ubuntu).</p>
<h3 id="1b-alternative-option-install-ethereum-on-your-os">1B. (Alternative option) Install Ethereum on your OS</h3>
<p>If you are good with option 1A, you can skip 1B. This step is for who want to install Ethereum on their OS.</p>
<p>We will use <code>Geth</code>, the Ethereum client implemented in Language <code>Go</code>. You can choose to either install the <code>Geth</code> on you own machine or the Linux machine running on VirtualBox. See <a href="https://github.com/ethereum/go-ethereum/wiki/Building-Ethereum">here</a> for more information.</p>
<p><strong><em>Ubuntu Users</em></strong></p>
<p>Here is the instructions to install the <code>Geth</code> for Ubuntu.</p>
<p>Even when you are not using Ubuntu as native OS, you can set up VirtualBox and download a Ubuntu-1604-LTS image from [<a href="http://releases.ubuntu.com/16.04.5/">here</a>]. This image is typically 1 GB, much smaller than the 7 GB image above. To set up an empty Ubuntu OS on VirtualBox, here is a useful [<a href="https://medium.com/@tushar0618/install-ubuntu-16-04-lts-on-virtual-box-desktop-version-30dc6f1958d0">link</a>].</p>
<p><strong><em>Script 1b</em></strong>: </p>
<pre><code>sudo apt-get install software-properties-common
sudo add-apt-repository -y ppa:ethereum/ethereum
sudo apt-get update
sudo apt-get install ethereum
</code></pre>
<p><strong><em>Mac Users</em></strong></p>
<p><strong><em>Script 1bb</em></strong>: </p>
<pre><code>brew tap ethereum/ethereum
brew install ethereum
</code></pre>
<p><strong><em>Windows Users</em></strong></p>
<p>https://github.com/ethereum/go-ethereum/wiki/Installation-instructions-for-Windows</p>
<h3 id="2-join-the-blockchain-network">2. Join the Blockchain network</h3>
<p><strong>2.1 Connect to the Blockchain Gateway (Bootnode)</strong>: Every blockchain starts with the genesis block. When you run geth with default settings for the first time, the main net genesis block is committed to the database. For a private network, you usually want a different genesis block. We have a pre-defined custom [<a href="genesis.json">genesis.json</a>] file. The <code>config</code> section ensures that certain protocol upgrades are immediately available. The <code>alloc</code> section pre-funds accounts, which is currently empty. Following the instructions below to run geth.</p>
<p><strong><em>Script 2.1</em></strong>: </p>
<pre><code>mkdir -p ~/lab1/bkc_data
cd ~/lab1
geth --datadir bkc_data init ~/lab1/genesis.json # create a database that uses this genesis block
geth --datadir bkc_data --rpc --networkid 89992018 --bootnodes &quot;enode://764242277ec5ad520944549199ecc590e99f4cb379e82441ec4027a25624ca88a7b177db15e4b943fc295288a18885b7a29f0a91b624ddad0629e70752ed6acd@128.230.210.231:30301&quot;  console  2&gt;console.log 
</code></pre>
<p><strong>Note: If the geth failed to start due to errors such as 'undefined flags rpc', try to replace 'rpc' with 'http'.</strong></p>
<p>In the last command above, <code>--networkid</code> specify the private network ID. Connections between nodes are valid only if peers have identical protocol version and network ID, you can effectively isolate your network by setting either of these to a non default value. <code>--bootnode</code> option specify the bootnode address, following the format <code>[nodeID]:IP:port</code>. Every subsequent Geth node pointed to the bootnode for peer discovery. <a href="https://github.com/ethereum/go-ethereum/wiki/Command-Line-Options">This page</a> describes the options for <code>geth</code> commands.</p>
<p>Check the connectivity by running:</p>
<p><strong><em>Script 2.3</em></strong>: </p>
<pre><code>&gt; admin.peers
</code></pre>
<p>This command should return non-empty text about the peer nodes connected by your miner node.</p>
<h3 id="3a-get-coins-by-transactions">3A. Get Coins by Transactions</h3>
<p><strong><em>Script 3a.1</em></strong>: </p>
<pre><code>&gt; personal.newAccount() # create an Account
&gt; eth.accounts # check accounts
</code></pre>
<p>Publish your account identity to the public bulletin (https://goo.gl/6WHAq9). The TA will send some coins to your account.
After that, you can check the balance.</p>
<p><strong><em>Script 3a.2</em></strong>: </p>
<pre><code>&gt; web3.fromWei(eth.getBalance(eth.accounts[0]),&quot;ether&quot;)
</code></pre>
<h3 id="3b-get-coins-by-mining">3B. Get Coins by Mining</h3>
<p>Before mining, the coinbase has to be specified to one personal account, where your earnings will be settled. Run following commands to create a new account, and set it as coinbase.</p>
<p><strong><em>Script 3b.1</em></strong>: </p>
<pre><code>&gt; personal.newAccount() # create an Account
&gt; eth.accounts # check accounts
&gt; miner.setEtherbase(eth.accounts[0]) # that address that will receive your earnings
</code></pre>
<p>You can now start/stop the miner. If mining doesn't seem to work, you may try to unlock your account and start mining again:</p>
<pre><code>&gt; personal.unlockAccount(“accountAddress”, “accountPassword”)
&gt; personal.unlockAccount(“accountAddress”, “accountPassword”, expiration_time)
</code></pre>
<p><strong><em>Script 3b.2</em></strong>: </p>
<pre><code>&gt; miner.start(1)# one thread in this case, you can increase the thread number to increase the mining power so that you can compete with remote server.
&gt; miner.stop()
</code></pre>
<p>Mining takes a while to get start, you can monitor the event log by</p>
<p><strong><em>Script 3b.3</em></strong>: </p>
<pre><code>tail -f ~/lab1/console.log
</code></pre>
<p>To know currently you are mining or not, you can run </p>
<p><strong><em>Script 3b.4</em></strong>: </p>
<pre><code>&gt; eth.hashrate # get the current mining power
&gt; eth.blockNumber # current top block.
</code></pre>
<p>If you find your account has non-zero balance, you get some coins through mining:</p>
<p><strong><em>Script 3b.5</em></strong>: </p>
<pre><code>&gt; web3.fromWei(eth.getBalance(eth.accounts[0]),&quot;ether&quot;)
</code></pre>
<p>The list of <code>Geth</code> commands can be found on [<a href="https://github.com/ethereum/go-ethereum/wiki/Management-APIs">this page</a>].</p>
<h2 id="lab-tasks">Lab Tasks</h2>
<p>The tasks in this lab require to inspect and modify the content of Blockchain. In addition to the Ethereum commands you used  above, there are other relevant commands as below.</p>
<pre><code>&gt; eth.accounts[0] # check the account id
&gt; eth.getBalance(&lt;account&gt;) # check the balance for one account, the argument is account id
&gt; web3.fromWei(&lt;value&gt;,&quot;ether&quot;) # convert Wei to Ether
&gt; web3.toWei(&lt;value&gt;,&quot;ether&quot;) #convert Ether to Wei
&gt; eth.blockNumber # check the latest block number on the chain
&gt; eth.getBlock(eth.blockNumber-3) # display a certain block 
&gt; eth.getBlock('latest', true) # display the latest block
&gt; eth.getBlock('pending', true) # display the pending block
&gt; eth.sendTransaction({from:eth.accounts[0], to:&quot;0xda1b60c80502fea9977bab42dcebad05c289dcd2&quot;, value:web3.toWei(1,&quot;ether&quot;)})
#eth.sendTransaction({from:senderAccount, to:receiverAccount, value: amount})
&gt; eth.getTransaction(&quot;0x57dfe8f7f4760f09cd76a8b09000fd43275d798503ed88ed6d8b39c1d5ce3157&quot;)
&gt; loadScript(&quot;/path/to/script.js&quot;) #run script.js (all the commands there) inside the geth console.
</code></pre>
<p><strong>Task 1:</strong> After you started mining, show the coins that you have mined. Then wait 1 minute, check the balance again.</p>
<p><strong>Task 2:</strong> Show the latest five blocks and the latest two transaction confirmed in the blockchain. Then wait 1 minute, show the blockchain again and see how if it is extended by new blocks over time. (Hint: To find the latest transaction on the blockchain, you can iterate through the blocks and check the transaction(s) in them. To iterate through the blocks, you can use JavaScript. Alternatively, you can programming with Python with the Web3py library, see web3py.md for the sample code.)</p>
<p><strong>Task 3:</strong> </p>
<ol>
<li>
<p>Submit a transaction, say <code>tx1</code>, to the blockchain. You create another account as the recipient (seller) of the transaction. </p>
</li>
<li>
<p>Show whether transaction <code>tx1</code> is included in the Blockchain; if not wait for a while, check again.</p>
</li>
</ol>
<p>Note 1: The above command will return a hash tag which served as the ID of the transaction, you could use that ID to query the transaction in the future.</p>
<p>Note 2: <a href="http://www.ethdocs.org/en/latest/ether.html">Ether</a> is the name of the currency used within Ethereum. Wei is the smallest unit in Ethereum. 1 Ether = 10^18 Wei. The account balance and transfer amount are shown in Wei. You can use the converter utility web3.fromWei and web3.toWei to convert between Ether and Wei. </p>
<h2 id="deliverable">Deliverable</h2>
<ul>
<li>For each task, you should submit the following:<ol>
<li>The script program consisting of the Geth commands</li>
<li>The screenshot that shows your script has run successfully on your computer<ul>
<li>Make sure include your name in the screenshot. For instance, you can open a text editor and type your name in it. </li>
</ul>
</li>
</ol>
</li>
</ul>
<h2 id="faqtrouble-shooting">FAQ/Trouble shooting</h2>
<ul>
<li>Q1: When sending transaction, I got this error: "account is locked"</li>
<li>Answer: Before sending transactions, you may need to unlock your personal wallet/account and input passphrase. Example:</li>
</ul>
<pre><code>personal.unlockAccount(eth.accounts[0])
</code></pre>
<ul>
<li>Q2: In Mining, I keep getting zero balance?<ul>
<li>Answer: One of possible reasons is your VM/OS does not have enough memory. We recommend at least 4 GB for mining. If you don't run mining, you don't have to allocate large memory for this lab.</li>
</ul>
</li>
<li>Q3: When my terminal crashes in VM (e.g., during mining),  I cannot restart the <code>geth</code> properly.<ul>
<li>Answer: You can restart the VM to get around this issue. (Terminal crash may mess up network stack in your VM which <code>geth</code> depends on).</li>
</ul>
</li>
<li>
<p>Q4: How to check if my node is mining?</p>
<ul>
<li>Answer: You can check by running "eth.mining", it returns "true" or "false" to indicate if the mining is on-going or not. Note: Command <code>eth.hashrate</code> may return "0" even if the mining process is active. </li>
</ul>
</li>
<li>
<p>Q5: I choose options 1.A to setup the environment, and it is running out of disk memory, what would I do?</p>
<ul>
<li>Answer: You have two options.
    1, You can choose to install a Ubuntu inside of VirtualBox and start from option 1.B (recommended)
    2, you can add a new virtual hard disk to your current virtual machine.
        Step 1:  Follow the instructions in the below link (but skipping the last step - "mounting the partition") [<a href="http://www.vitalsofttech.com/add-disk-storage-to-oracle-virtualbox-with-linux/">Add Disk Storage</a>]. Step 2: Run the below command to cleanup some space
           <code>sudo rm -rf /var/*</code>
           Step 3. Run the below command to mount the new disk to the home directory. <code>sudo mount /dev/sdb1 ~</code></li>
</ul>
</li>
<li>
<p>Q6: Why does <code>admin.peers</code> return null sometimes?</p>
<ul>
<li><code>admin.peers</code> returns you the information about connected remote nodes and it seems like the method uses public IP addresses for this. Few students mentioned that <code>admin.peers</code> runs successfully when they run it outside of the school network while it failed in the shcool network. Even though it's returning null, you should still be able to mine your own coins if you connected to the private blockchain network successfully.</li>
</ul>
</li>
<li>
<p>Q7: Out of space?</p>
</li>
<li>
<p>Clear the folder  ~/.ethereum/ after you finish the lab. Also, clear the folder specified through ``--datadir'' when starting geth.</p>
</li>
</ul></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js" defer></script>
        <script src="../../javascripts/mathjax.js" defer></script>
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6" defer></script>
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" defer></script>
        <script src="../../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
